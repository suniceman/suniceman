---
layout: post
title:  mongodb删除重复数据
date:   2017-08-24 13:32:20 +0300
description: mongodb删除重复数据. # Add post description (optional)
img: post-2.jpg # Add image post (optional)
tags: [mongodb, 数据库]
author: # Add name author (optional)
---
 > 注：mongodb当前版本是3.4.3

删除重复数据的mongo语句：
```javascript
db.userInfo.aggregate([
    {
        $group: {
          _id: {userName: '$userName',age: '$age'},
          count: {$sum: 1},
          dups: {$addToSet: '$_id'}
        }
    },
    {
        $match: {count: {$gt: 1}}
    }
]).forEach(function(doc){
    doc.dups.shift();
    db.userInfo.remove({_id: {$in: doc.dups}});
})
```

1. 根据userName和age分组并统计数量，$group只会返回参与分组的字段，使用$addToSet在返回结果数组中增加_id字段
2. 使用$match匹配数量大于1的数据
3. doc.dups.shift();表示从数组第一个值开始删除；作用是踢除重复数据其中一个_id，让后面的删除语句不会删除所有数据
4. 使用forEach循环根据_id删除数据

  $addToSet 操作符只有在值没有存在于数组中时才会向数组中添加一个值。如果值已经存在于数组中，$addToSet返回，不会修改数组。

> 注意：forEach和$addToSet的驼峰写法不能全部写成小写